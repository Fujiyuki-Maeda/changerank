<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∫óËàóÂà• Â£≤‰∏ä„É©„É≥„Ç≠„É≥„Ç∞Êé®Áßª</title>
    <style>
        /* Base */
        :root{ --bg:#f6f7fb; --card:#ffffff; --muted:#6c757d; --accent:#28a745; --surface:#f8f9fa }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background-color: var(--bg); margin: 0; padding: 18px; color: #222; }
        .container { max-width: 1280px; margin: 0 auto; background: var(--card); padding: 24px; border-radius: 10px; box-shadow: 0 6px 20px rgba(20,20,40,0.04); }

        h1 { text-align: left; font-size: 1.6rem; margin: 0 0 6px 0; color: #1f2d3d; }
        .sub-title { color: var(--muted); margin-bottom: 18px; font-size: 0.98rem; }

        .nav-links { text-align: left; margin-bottom: 12px; }
        .nav-links a { text-decoration: none; color: var(--muted); font-weight: 700; padding: 6px 10px; border-radius: 6px; background: #fff; border:1px solid #efefef }

        /* Controls */
        .controls-area { background: var(--surface); padding: 12px 14px; border-radius: 8px; margin-bottom: 14px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .dept-select { padding: 8px 12px; font-size: 15px; border-radius: 6px; border: 1px solid #d6dbe0; cursor: pointer; min-width: 160px; }

        /* Filter */
        .filter-box { background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 18px; border: 1px solid #ececec; }
        .filter-summary { cursor: pointer; font-weight: 800; color: #444; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; max-height: 280px; overflow-y: auto; padding: 10px; border-radius: 6px; }
        .shop-item label { display: flex; align-items: center; cursor: pointer; font-size: 0.95rem; color: #333; }
        .shop-item input { margin-right: 8px; transform: translateY(-1px); }
        .filter-actions { margin-top: 10px; text-align: right; }
        .btn-filter { background: var(--accent); color: white; border: none; padding: 8px 18px; border-radius: 6px; cursor: pointer; font-weight: 700; }
        .btn-filter:hover { filter: brightness(0.95); }
        .btn-reset { background: transparent; color: var(--muted); text-decoration: none; padding: 8px 14px; border-radius: 6px; border:1px solid #f0f0f0 }

        /* Table */
        .table-responsive { overflow-x: auto; }
        .history-table { width: 100%; border-collapse: collapse; min-width: 860px; background: transparent; }
        .history-table th, .history-table td { padding: 12px 10px; border-bottom: 1px solid #f1f1f3; text-align: center; vertical-align: middle; }
        .history-table thead th { position: sticky; top: 0; z-index: 20; background: linear-gradient(180deg,#2fa04b,#238a3b); color: #fff; font-weight: 700; }
        .history-table th.shop-col { position: sticky; left: 0; z-index: 30; width: 180px; text-align: left; padding-left: 18px; }
        .history-table td.shop-col { position: sticky; left: 0; z-index: 10; background: #fff; font-weight: 700; text-align: left; border-right: 1px solid #f0f0f2; }

        .history-table tbody tr:nth-child(odd) td { background: #fff; }
        .history-table tbody tr:nth-child(even) td { background: #fbfbfc; }
        .history-table tbody tr:hover td { background: #f6fff6; }

        /* Rank badges */
        .rank-num { font-size: 1.05rem; font-weight: 800; display: inline-block; margin-right: 6px; }
        .rank-1 { color: #d84315; font-size: 1.25rem; }
        .rank-2, .rank-3 { color: #2d3b45; }

        .diff { font-size: 0.82rem; display:block; margin-top:4px; }
        .rank-up { color: #e74c3c; }
        .rank-down { color: #3498db; }
        .rank-same { color: #9aa3ad; }

        /* Badges */
        .badge { font-size: 0.72rem; padding: 4px 7px; border-radius: 6px; color: white; font-weight: 700; display: inline-block; margin-top: 6px; }
        .store-new { background-color: #f39c12; }
        .store-closed { background-color: #7f8c8d; }

        .no-data { color: #bfc7cc; font-size: 0.86rem; }

        /* Responsive */
        @media (max-width:1024px){
            .container{ padding:14px }
            .history-table th.shop-col{ width:150px }
            .history-table th, .history-table td{ padding:10px 6px; font-size:0.88rem }
            .shop-grid{ grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-links">
        <a href="{% url 'dashboard' %}">‚Üê ÈÉ®ÈñÄ„É©„É≥„Ç≠„É≥„Ç∞„Å´Êàª„Çã</a>
    </div>

    <h1>üè¢ Â∫óËàóÂà• Â£≤‰∏ä„É©„É≥„Ç≠„É≥„Ç∞</h1>
    <div class="sub-title">ÂØæË±°: <strong>{{ selected_dept_name }}</strong></div>

    {% if error %}
        <p style="color: red; text-align: center; margin-top: 20px;">{{ error }}</p>
    {% else %}

        <!-- ÈÉ®ÈñÄÈÅ∏Êäû„Ç®„É™„Ç¢ -->
        <form method="get" action="" id="deptForm" class="controls-area">
            <label for="dept-select" style="font-weight: bold;">üìÇ Ë°®Á§∫„Åô„ÇãÈÉ®ÈñÄ:</label>
            <select name="dept_code" id="dept-select" class="dept-select" onchange="this.form.submit()">
                <option value="" {% if not selected_dept_code %}selected{% endif %}>ÂÖ®Â∫óÂêàË®à</option>
                {% for dept in all_10_depts %}
                    <option value="{{ dept.code }}" {% if selected_dept_code == dept.code|stringformat:"s" %}selected{% endif %}>
                        {{ dept.name }}
                    </option>
                {% endfor %}
            </select>

            <label for="month-select" style="font-weight: bold;">üìÖ ÂØæË±°Êúà:</label>
            <select name="month" id="month-select" class="dept-select" onchange="this.form.submit()">
                {% for val,label in month_choices %}
                    <option value="{{ val }}" {% if val == target_month %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>

            <!-- ÈÅ∏Êäû‰∏≠„ÅÆÂ∫óËàóID„ÇÇhidden„Åß‰øùÊåÅ„Åô„Çã -->
            {% for sid in selected_shop_ids %}
                <input type="hidden" name="selected_shops" value="{{ sid }}">
            {% endfor %}
        </form>

        <!-- Â∫óËàóÁµû„ÇäËæº„Åø„Ç®„É™„Ç¢ -->
        <details class="filter-box" {% if selected_shop_ids %}open{% endif %}>
            <summary class="filter-summary">üîç ÊØîËºÉ„Åô„ÇãÂ∫óËàó„ÇíÈÅ∏ÊäûÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñãÈñâÔºâ</summary>
            <div class="filter-content">
                <form method="get" action="">
                    <!-- ÈÅ∏Êäû‰∏≠„ÅÆÈÉ®ÈñÄ„ÇÇhidden„Åß‰øùÊåÅ -->
                    <input type="hidden" name="dept_code" value="{{ selected_dept_code|default:'' }}">
                    <input type="hidden" name="month" value="{{ target_month|default:'total' }}">

                    <div class="shop-grid">
                        {% for shop in checkbox_shops %}
                            <div class="shop-item">
                                <label>
                                    <input type="checkbox" name="selected_shops" value="{{ shop.id }}"
                                        {% if shop.id in selected_shop_ids %}checked{% endif %}>
                                    {{ shop.name }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="filter-actions">
                        <a href="{% url 'shop_ranking' %}?dept_code={{ selected_dept_code|default:'' }}&month={{ target_month|default:'total' }}" class="btn-reset">ÂÖ®Ëß£Èô§„Åó„Å¶Ë°®Á§∫</a>
                        <button type="submit" class="btn-filter">ÈÅ∏Êäû„Åó„ÅüÂ∫óËàó„ÇíË°®Á§∫</button>
                    </div>
                </form>
            </div>
        </details>

        <div class="table-responsive">
            <table class="history-table">
                <thead>
                    <tr>
                        <th class="shop-col">Â∫óËàóÂêç</th>
                        {% for year in years %}
                            <th>{{ year }}Âπ¥</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_data %}
                    <tr>
                        <td class="shop-col">{{ row.name }}</td>
                        {% for cell in row.cells %}
                            <td>
                                {% if cell.rank %}
                                    <div>
                                        <span class="rank-num rank-{{ cell.rank }}">
                                            {% if cell.rank == 1 %}ü•á{% elif cell.rank == 2 %}ü•à{% elif cell.rank == 3 %}ü•â{% else %}{{ cell.rank }}‰Ωç{% endif %}
                                        </span>

                                        {% if cell.status_text == "Êñ∞Â∫ó" %}
                                            <br><span class="badge store-new">Êñ∞Â∫ó</span>
                                        {% elif cell.diff_icon %}
                                            <span class="diff {{ cell.diff_class }}">
                                                {{ cell.diff_icon }}
                                            </span>
                                        {% else %}
                                            <span class="diff" style="color: transparent;">-</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    {% if cell.status_text == "ÈñâÂ∫ó" %}
                                        <span class="badge store-closed">ÈñâÂ∫ó</span>
                                    {% else %}
                                        <span class="no-data">-</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p style="text-align: right; font-size: 0.8rem; color: #777; margin-top: 10px;">‚Äª Áü¢Âç∞„ÅØÂâçÂπ¥„Å®„ÅÆÈ†Ü‰ΩçÊØîËºÉ„ÄÅ<span class="badge store-new">Êñ∞Â∫ó</span>„ÅØÊñ∞Ë¶è„Ç™„Éº„Éó„É≥„ÄÅ<span class="badge store-closed">ÈñâÂ∫ó</span>„ÅØ„Éá„Éº„ÇøÁÑ°„Åó„ÇíË°®„Åó„Åæ„Åô</p>
    {% endif %}
</div>

</body>
</html>