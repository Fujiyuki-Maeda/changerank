<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—èˆ—åˆ¥ å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°æ¨ç§»</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        h1 { text-align: center; font-size: 1.8rem; margin-bottom: 10px; color: #2c3e50; }
        .sub-title { text-align: center; color: #666; margin-bottom: 30px; font-size: 1.1rem; }
        
        .nav-links { text-align: left; margin-bottom: 20px; }
        .nav-links a { text-decoration: none; color: #6c757d; font-weight: bold; padding: 5px 10px; border-radius: 5px; background: #eee; transition: background 0.3s; }
        .nav-links a:hover { background: #ddd; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ï¼ˆéƒ¨é–€é¸æŠãªã©ï¼‰ */
        .controls-area { 
            background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;
        }
        .dept-select { padding: 8px 15px; font-size: 16px; border-radius: 4px; border: 1px solid #ced4da; cursor: pointer; min-width: 200px; }

        /* çµã‚Šè¾¼ã¿ã‚¨ãƒªã‚¢ */
        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .filter-summary { cursor: pointer; font-weight: bold; color: #007bff; outline: none; }
        .filter-content { margin-top: 15px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 4px; }
        .shop-item label { display: flex; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .shop-item input { margin-right: 6px; }
        .filter-actions { margin-top: 10px; text-align: right; }
        .btn-filter { background: #007bff; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-filter:hover { background: #0056b3; }
        .btn-reset { background: #6c757d; color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; margin-right: 10px; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .table-responsive { overflow-x: auto; }
        .history-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        .history-table th, .history-table td { 
            padding: 12px 8px; 
            border: 1px solid #eee; 
            text-align: center;
            font-size: 0.95rem;
            vertical-align: middle;
        }
        
        .history-table th { background: #28a745; color: white; white-space: nowrap; }
        .history-table th.shop-col { position: sticky; left: 0; z-index: 10; background: #1e7e34; width: 150px; }
        .history-table td.shop-col { 
            position: sticky; left: 0; z-index: 5; 
            background: #f8f9fa; font-weight: bold; text-align: left; 
            border-right: 2px solid #ddd;
        }

        /* ãƒ©ãƒ³ã‚¯è¡¨ç¤º */
        .rank-num { font-size: 1.1rem; font-weight: bold; display: inline-block; margin-right: 5px; }
        .rank-1 { color: #d32f2f; font-size: 1.3rem; text-shadow: 1px 1px 0px rgba(0,0,0,0.1); }
        .rank-2 { color: #2c3e50; }
        .rank-3 { color: #2c3e50; }
        
        /* å¤‰å‹•è¡¨ç¤º */
        .diff { font-size: 0.85rem; font-weight: bold; display: block; margin-top: 2px; }
        .rank-up { color: #e74c3c; }   /* èµ¤: ä¸Šæ˜‡ */
        .rank-down { color: #3498db; } /* é’: ä¸‹é™ */
        .rank-same { color: #ccc; }    /* ç°: ç¶­æŒ */
        
        /* æ–°åº—ãƒ»é–‰åº—ãƒãƒƒã‚¸ */
        .badge { 
            font-size: 0.75rem; padding: 3px 6px; border-radius: 4px; color: white; font-weight: bold; display: inline-block; margin-top: 2px; white-space: nowrap;
        }
        .store-new { background-color: #e67e22; } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
        .store-closed { background-color: #95a5a6; } /* ã‚°ãƒ¬ãƒ¼ */

        .no-data { color: #ccc; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-links">
        <a href="{% url 'dashboard' %}">â† éƒ¨é–€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</a>
    </div>

    <h1>ğŸ¢ åº—èˆ—åˆ¥ å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
    <div class="sub-title">å¯¾è±¡: <strong>{{ selected_dept_name }}</strong></div>
    
    {% if error %}
        <p style="color: red; text-align: center; margin-top: 20px;">{{ error }}</p>
    {% else %}
        
        <!-- éƒ¨é–€é¸æŠã‚¨ãƒªã‚¢ -->
        <form method="get" action="" id="deptForm" class="controls-area">
            <label for="dept-select" style="font-weight: bold;">ğŸ“‚ è¡¨ç¤ºã™ã‚‹éƒ¨é–€:</label>
            <select name="dept_code" id="dept-select" class="dept-select" onchange="this.form.submit()">
                <option value="" {% if not selected_dept_code %}selected{% endif %}>å…¨åº—åˆè¨ˆ</option>
                {% for dept in all_10_depts %}
                    <option value="{{ dept.code }}" {% if selected_dept_code == dept.code|stringformat:"s" %}selected{% endif %}>
                        {{ dept.name }}
                    </option>
                {% endfor %}
            </select>
            
            <!-- é¸æŠä¸­ã®åº—èˆ—IDã‚‚hiddenã§ä¿æŒã™ã‚‹ -->
            {% for sid in selected_shop_ids %}
                <input type="hidden" name="selected_shops" value="{{ sid }}">
            {% endfor %}
        </form>

        <!-- åº—èˆ—çµã‚Šè¾¼ã¿ã‚¨ãƒªã‚¢ -->
        <details class="filter-box" {% if selected_shop_ids %}open{% endif %}>
            <summary class="filter-summary">ğŸ” æ¯”è¼ƒã™ã‚‹åº—èˆ—ã‚’é¸æŠï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰</summary>
            <div class="filter-content">
                <form method="get" action="">
                    <!-- é¸æŠä¸­ã®éƒ¨é–€ã‚‚hiddenã§ä¿æŒ -->
                    <input type="hidden" name="dept_code" value="{{ selected_dept_code|default:'' }}">
                    
                    <div class="shop-grid">
                        {% for shop in checkbox_shops %}
                            <div class="shop-item">
                                <label>
                                    <input type="checkbox" name="selected_shops" value="{{ shop.id }}"
                                        {% if shop.id in selected_shop_ids %}checked{% endif %}>
                                    {{ shop.name }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="filter-actions">
                        <a href="{% url 'shop_ranking' %}?dept_code={{ selected_dept_code|default:'' }}" class="btn-reset">å…¨è§£é™¤ã—ã¦è¡¨ç¤º</a>
                        <button type="submit" class="btn-filter">é¸æŠã—ãŸåº—èˆ—ã‚’è¡¨ç¤º</button>
                    </div>
                </form>
            </div>
        </details>

        <div class="table-responsive">
            <table class="history-table">
                <thead>
                    <tr>
                        <th class="shop-col">åº—èˆ—å</th>
                        {% for year in years %}
                            <th>{{ year }}å¹´</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_data %}
                    <tr>
                        <td class="shop-col">{{ row.name }}</td>
                        {% for cell in row.cells %}
                            <td>
                                {% if cell.rank %}
                                    <div>
                                        <span class="rank-num rank-{{ cell.rank }}">
                                            {% if cell.rank == 1 %}ğŸ¥‡{% elif cell.rank == 2 %}ğŸ¥ˆ{% elif cell.rank == 3 %}ğŸ¥‰{% else %}{{ cell.rank }}ä½{% endif %}
                                        </span>
                                        
                                        {% if cell.status_text == "æ–°åº—" %}
                                            <br><span class="badge store-new">æ–°åº—</span>
                                        {% elif cell.diff_icon %}
                                            <span class="diff {{ cell.diff_class }}">
                                                {{ cell.diff_icon }}
                                            </span>
                                        {% else %}
                                            <span class="diff" style="color: transparent;">-</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    {% if cell.status_text == "é–‰åº—" %}
                                        <span class="badge store-closed">é–‰åº—</span>
                                    {% else %}
                                        <span class="no-data">-</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p style="text-align: right; font-size: 0.8rem; color: #777; margin-top: 10px;">â€» çŸ¢å°ã¯å‰å¹´ã¨ã®é †ä½æ¯”è¼ƒã€<span class="badge store-new">æ–°åº—</span>ã¯æ–°è¦ã‚ªãƒ¼ãƒ—ãƒ³ã€<span class="badge store-closed">é–‰åº—</span>ã¯ãƒ‡ãƒ¼ã‚¿ç„¡ã—ã‚’è¡¨ã—ã¾ã™</p>
    {% endif %}
</div>

</body>
</html>