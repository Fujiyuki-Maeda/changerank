<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ shop_name }} å£²ä¸Šæ§‹æˆæ¯”æ¨ç§»</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .nav-links { margin-bottom: 20px; }
        .nav-links a { text-decoration: none; color: #6c757d; font-weight: bold; padding: 5px 10px; background: #eee; border-radius: 5px; }
        .chart-container { position: relative; height: 60vh; width: 100%; }

        /* â˜…ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›å‘ã‘ã®èª¿æ•´ (iPad / iPad mini) â˜… */
        @media screen and (max-width: 1024px) {
            body { padding: 10px; }
            .container { padding: 15px; width: 98%; }
            h1 { font-size: 1.5rem; }

            /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®å¯„ã›ã«ã—ã¦æŠ¼ã—ã‚„ã™ã */
            .action-buttons {
                justify-content: center;
            }
            .btn {
                font-size: 0.85rem;
                padding: 8px 12px;
                flex: 1 1 auto; /* å¹…ã‚’è‡ªå‹•èª¿æ•´ */
                text-align: center;
            }
            .separator { display: none; } /* ç‹­ã„ã¨ãã¯åŒºåˆ‡ã‚Šç·šã‚’æ¶ˆã™ */

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåˆ—ã‚’å°‘ã—ç‹­ãã—ã¦è¡¨ç¤ºé ˜åŸŸã‚’ç¢ºä¿ */
            .history-table th.dept-col { width: 140px; }
            .history-table th, .history-table td { font-size: 0.85rem; padding: 8px 4px; }

            /* ãƒãƒƒã‚¸ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
            .rank-num { font-size: 1rem; }
            .share-badge { font-size: 0.7rem; padding: 1px 4px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-links"><a href="{% url 'dashboard' %}">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>

    <h1>ğŸ  {{ shop_name }} å£²ä¸Šæ¨ç§»ã¨æ§‹æˆæ¯” (10å¹´åˆ†)</h1>

    {% if error %}
        <p style="color: red; text-align: center;">{{ error }}</p>
    {% else %}
        <div class="chart-container">
            <canvas id="hyugaChart"></canvas>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const labels = {{ labels|safe }};
                const datasets = {{ datasets|safe }};

                const ctx = document.getElementById('hyugaChart').getContext('2d');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'å£²ä¸Šæ¨ç§» (è¦æ¨¡)', // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: {
                                    display: false // â˜…é‡‘é¡ï¼ˆç›®ç››ã‚Šï¼‰ã‚’éš ã™
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.parsed.y;

                                        // åˆè¨ˆã‚’è¨ˆç®—ã—ã¦æ§‹æˆæ¯”ã‚’å‡ºã™
                                        const dataIndex = context.dataIndex;
                                        const allDatasets = context.chart.data.datasets;
                                        let total = 0;
                                        for (let i = 0; i < allDatasets.length; i++) {
                                            total += (allDatasets[i].data[dataIndex] || 0);
                                        }

                                        const percentage = total > 0 ? Math.round((value / total * 100) * 10) / 10 : 0;

                                        // â˜…é‡‘é¡ã‚’è¡¨ç¤ºã›ãšã€ï¼…ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹
                                        label += percentage + '%';

                                        return label;
                                    }
                                }
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            });
        </script>
    {% endif %}
    <!-- å£²ä¸Šãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆéƒ¨é–€ã‚’è¡Œã€å¹´ã‚’åˆ—ã«ã—ãŸæ¨ªæ–­ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ -->
    {% if table_rows and table_years %}
    <div style="margin-top:24px; overflow:auto;">
        <table style="width:100%; border-collapse:collapse; min-width:900px;">
            <thead>
                <tr>
                    <th style="text-align:left; padding:8px 12px; background:#f8f9fa; border-bottom:2px solid #e9ecef;">éƒ¨é–€</th>
                    {% for y in table_years %}
                    <th style="text-align:right; padding:8px 12px; background:#f8f9fa; border-bottom:2px solid #e9ecef;">{{ y }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in table_rows %}
                <tr>
                    <td style="padding:8px 12px; border-top:1px solid #f1f3f5;">{{ row.dept }}</td>
                    {% for v in row.values %}
                    <td style="padding:8px 12px; border-top:1px solid #f1f3f5; text-align:right;">{{ v }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th style="text-align:left; padding:8px 12px; background:#fafafa; border-top:2px solid #e9ecef;">åˆè¨ˆ</th>
                    {% for t in table_totals %}
                    <th style="text-align:right; padding:8px 12px; background:#fafafa; border-top:2px solid #e9ecef;">{{ t }}</th>
                    {% endfor %}
                </tr>
            </tfoot>
        </table>
    </div>
    {% endif %}
</div>

</body>
</html>