<!DOCTYPE html>
<html lang="ja">
<head>
     {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—èˆ—æ¯”è¼ƒ (å£²ä¸Šæ§‹æˆæ¯”)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }

        .nav-links { margin-bottom: 20px; }
        .nav-links a { text-decoration: none; color: #6c757d; font-weight: bold; padding: 5px 10px; background: #eee; border-radius: 5px; }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .control-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; }
        .form-group { margin-bottom: 15px; }
        .form-label { font-weight: bold; display: block; margin-bottom: 5px; }
        select { padding: 8px; font-size: 1rem; width: 100%; max-width: 300px; border-radius: 4px; border: 1px solid #ccc; }

        .special-option { margin-bottom: 10px; padding: 5px; background: #e2e3e5; border-radius: 4px; display: inline-block; }
        .special-option label { cursor: pointer; font-weight: bold; color: #333; }

        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; border-radius: 4px; }
        .checkbox-item label { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; }
        .checkbox-item input { margin-right: 5px; }

        .btn-submit { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1rem; width: 100%; }
        .btn-submit:hover { background: #218838; }

        .chart-container { position: relative; height: 60vh; width: 100%; }

        /* â˜…ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›å‘ã‘ã®èª¿æ•´ (iPad / iPad mini) â˜… */
        @media screen and (max-width: 1024px) {
            body { padding: 10px; }
            .container { padding: 15px; width: 98%; }
            h1 { font-size: 1.5rem; }

            /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®å¯„ã›ã«ã—ã¦æŠ¼ã—ã‚„ã™ã */
            .action-buttons {
                justify-content: center;
            }
            .btn {
                font-size: 0.85rem;
                padding: 8px 12px;
                flex: 1 1 auto; /* å¹…ã‚’è‡ªå‹•èª¿æ•´ */
                text-align: center;
            }
            .separator { display: none; } /* ç‹­ã„ã¨ãã¯åŒºåˆ‡ã‚Šç·šã‚’æ¶ˆã™ */

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåˆ—ã‚’å°‘ã—ç‹­ãã—ã¦è¡¨ç¤ºé ˜åŸŸã‚’ç¢ºä¿ */
            .history-table th.dept-col { width: 140px; }
            .history-table th, .history-table td { font-size: 0.85rem; padding: 8px 4px; }

            /* ãƒãƒƒã‚¸ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
            .rank-num { font-size: 1rem; }
            .share-badge { font-size: 0.7rem; padding: 1px 4px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="nav-links"><a href="{% url 'dashboard' %}">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>
    <h1>âš–ï¸ åº—èˆ—æ¯”è¼ƒ (å£²ä¸Šæ§‹æˆæ¯”)</h1>

    {% if error %}
        <p style="color: red; text-align: center;">{{ error }}</p>
    {% else %}
        <form method="get" class="control-panel">
            <div class="form-group">
                <label class="form-label">ğŸ“… å¯¾è±¡å¹´:</label>
                <select name="year">
                    {% for y in years %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}å¹´</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ  è‡ªåº— (åŸºæº–):</label>
                <div style="padding: 8px 12px; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; color: #495057; font-weight: bold; width: 100%; max-width: 300px;">
                    {{ target_shop_name }}
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ¢ æ¯”è¼ƒã™ã‚‹åº—èˆ— (è¤‡æ•°é¸æŠå¯):</label>

                <!-- â˜…è¿½åŠ : ä»–åº—åˆè¨ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                <div class="special-option">
                    <label>
                        <input type="checkbox" name="comparison_shops" value="all_others" {% if include_all_others %}checked{% endif %}>
                        ğŸ“Š å…¨åº—åˆè¨ˆï¼ˆæ—¥å‘é™¤ãï¼‰
                    </label>
                </div>

                <div class="checkbox-grid">
                    {% for shop in all_shops %}
                        <div class="checkbox-item">
                            <label>
                                <input type="checkbox" name="comparison_shops" value="{{ shop.value }}"
                                    {% if shop.value in selected_display_values %}checked{% endif %}>
                                {{ shop.display }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <button type="submit" class="btn-submit">ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º</button>
        </form>

        <div class="chart-container">
            <canvas id="comparisonChart"></canvas>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const chartData = {{ chart_data|default:"{}"|safe }};

                if (!chartData.datasets || chartData.datasets.length === 0) {
                    return;
                }

                const ctx = document.getElementById('comparisonChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: 'æ§‹æˆæ¯” (%)' }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            });
        </script>

        <!-- å£²ä¸Šãƒ†ãƒ¼ãƒ–ãƒ«: éƒ¨é–€ã‚’è¡Œã€åº—èˆ—ã‚’åˆ—ã«ã—ãŸæ¨ªæ–­ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div style="margin-top:24px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; min-width:800px;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding:8px 12px; background:#f8f9fa; border-bottom:2px solid #e9ecef;">éƒ¨é–€</th>
                        {% for s in table_shops %}
                        <th style="text-align:right; padding:8px 12px; background:#f8f9fa; border-bottom:2px solid #e9ecef;">{{ s.name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_rows %}
                    <tr>
                        <td style="padding:8px 12px; border-top:1px solid #f1f3f5;">{{ row.dept }}</td>
                        {% for v in row.values %}
                        <td style="padding:8px 12px; border-top:1px solid #f1f3f5; text-align:right;">{{ v }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th style="text-align:left; padding:8px 12px; background:#fafafa; border-top:2px solid #e9ecef;">åˆè¨ˆ</th>
                        {% for s in table_shops %}
                        <th style="text-align:right; padding:8px 12px; background:#fafafa; border-top:2px solid #e9ecef;">{{ s.total }}</th>
                        {% endfor %}
                    </tr>
                </tfoot>
            </table>
        </div>
    {% endif %}
</div>
</body>
</html>