<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨é–€åˆ¥ã‚·ã‚§ã‚¢æ¨ç§»</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }

        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background 0.3s;
        }
        .back-btn:hover { background: #5a6268; }

        .chart-container { position: relative; height: 60vh; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <a href="{% url 'dashboard' %}" class="back-btn">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</a>

    <h1>ğŸ“ˆ ã‚°ãƒ«ãƒ¼ãƒ—åº—ç·åˆ éƒ¨é–€åˆ¥ å£²ä¸Šã‚·ã‚§ã‚¢æ¨ç§»</h1>

    {% if error %}
        <p style="color: red; text-align: center;">{{ error }}</p>
    {% else %}
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:10px;">
            <form id="monthForm" method="get" style="margin:0;">
                <label for="monthSelect" style="font-weight:600; margin-right:8px;">æœˆãƒ•ã‚£ãƒ«ã‚¿:</label>
                <select id="monthSelect" name="month" style="padding:6px 8px; border-radius:6px; border:1px solid #ccc;">
                    <option value="">å…¨ã¦</option>
                    {% for m in month_choices %}
                        <option value="{{ m.value }}" {% if target_month and m.value == target_month %}selected{% endif %} {% if m.disabled %}disabled{% endif %}>{{ m.name }}</option>
                    {% endfor %}
                </select>
            </form>
            <div style="font-size:0.9rem; color:#666;">è¡¨ç¤ºç‚¹æ•°: {{ labels|length }}</div>
        </div>

        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>

        

        <!-- é‡‘é¡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚µãƒ¼ãƒå´ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ï¼‰ -->
        <div style="margin-top:12px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <thead>
                    <tr style="background:#f1f5f9;">
                        <th style="padding:8px; border:1px solid #e6edf3; text-align:left;">éƒ¨é–€å</th>
                        {% for lbl in labels_list %}
                            <th style="padding:8px; border:1px solid #e6edf3; text-align:right;">{{ lbl }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in amounts_table %}
                        <tr>
                            <td style="padding:6px 8px; border:1px solid #eef3f7;">{{ row.name }}</td>
                            {% for a in row.amounts %}
                                <td style="padding:6px 8px; border:1px solid #eef3f7; text-align:right;">{{ a }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <script>
    document.addEventListener('DOMContentLoaded', function() {
        const labels = {{ labels|default:"[]"|safe }};
        const datasets = {{ datasets|default:"[]"|safe }};

        // å¼·åˆ¶çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•°å€¤åŒ–ã—ã€å…¨ãƒ‡ãƒ¼ã‚¿ã®æœ€å¤§å€¤ã‹ã‚‰ Y è»¸ä¸Šé™ã‚’æ±ºã‚ã‚‹
        (function(){
            try{
                datasets.forEach(ds => {
                    if (Array.isArray(ds.data)){
                        ds.data = ds.data.map(v => {
                            if (v === null || v === undefined || v === '') return null;
                            if (typeof v === 'number') return v;
                            // remove commas and coerce
                            const n = Number(String(v).replace(/,/g, ''));
                            return isNaN(n) ? null : n;
                        });
                    }
                });
            }catch(e){ console.warn('data coercion failed', e); }
        })();

        // Yè»¸ã®æœ€å¤§å€¤ã‚’å‹•çš„ã«è¨ˆç®—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¯ã€ã“ã“ã§ã¯ä¸€æ—¦ä½¿ã‚ãªã„
        // function updateYAxisMax(chart) { ... }

        const ctx = document.getElementById('trendChart').getContext('2d');

        // Yè»¸ã®é©åˆ‡ãªä¸Šé™ã‚’è¨­å®š
        let globalMax = 0;
        datasets.forEach(ds => { if (Array.isArray(ds.data)) ds.data.forEach(v => { if (typeof v === 'number' && !isNaN(v)) globalMax = Math.max(globalMax, v); }); });
        const suggestedMax = globalMax > 0 ? Math.ceil(globalMax / 10) * 10 : 10;

        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: suggestedMax,
                        title: {
                            display: true,
                            text: 'ã‚·ã‚§ã‚¢ (%)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + '%';
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        },
                        // ã‚«ã‚¹ã‚¿ãƒ  onClick: ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆãŸå¾Œã«
                        // è¡¨ç¤ºä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã¦ Y è»¸ã®ä¸Šé™ã‚’å†è¨ˆç®—ã™ã‚‹
                        onClick: function(e, legendItem, legend) {
                            const ci = legend.chart;
                            const index = legendItem.datasetIndex;
                            const meta = ci.getDatasetMeta(index);
                            // toggle hidden state
                            meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : !meta.hidden;

                            // å†è¨ˆç®—: è¡¨ç¤ºä¸­ã®ãƒ‡ãƒ¼ã‚¿ã®æœ€å¤§å€¤ã‚’æ±‚ã‚ã‚‹
                            let gmax = 0;
                            ci.data.datasets.forEach((ds, i) => {
                                const m = ci.getDatasetMeta(i);
                                if (!m.hidden) {
                                    if (Array.isArray(ds.data)) {
                                        ds.data.forEach(v => { if (typeof v === 'number' && !isNaN(v)) gmax = Math.max(gmax, v); });
                                    }
                                }
                            });
                            const newMax = gmax > 0 ? Math.ceil(gmax / 10) * 10 : 10;
                            ci.options.scales.y.max = newMax;
                            ci.update();
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        // åˆæœŸæç”»å¾Œã® Yè»¸æ›´æ–°ã‚‚ã“ã“ã§ã¯è¡Œã‚ãªã„
        // updateYAxisMax(myChart);
    });
</script>
        
        <script>
            // æœˆé¸æŠãŒå¤‰ã‚ã£ãŸã‚‰ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('monthSelect').addEventListener('change', function(){
                document.getElementById('monthForm').submit();
            });
        </script>
    {% endif %}
</div>

</body>
</html>