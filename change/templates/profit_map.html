<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ©ç›Šç‡ãƒãƒƒãƒ— (æ•£å¸ƒå›³)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; }
        h1 { text-align: center; color: #2c3e50; }
        .chart-container { position: relative; height: 70vh; width: 100%; margin-top: 20px; }
        .nav-links a { text-decoration: none; color: #6c757d; font-weight: bold; padding: 5px 10px; background: #eee; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container">
    <div class="nav-links"><a href="{% url 'dashboard' %}">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>
    <!-- æ–‡è¨€å¤‰æ›´: è’åˆ© â†’ ç²—åˆ© -->
    <h1>ğŸ“Š åˆ©ç›Šç‡ãƒãƒƒãƒ— (å£²ä¸Š vs ç²—åˆ©ç‡)</h1>
    
    <div style="text-align: center;">
        <form method="get">
            <select name="date" onchange="this.form.submit()" style="padding: 5px; font-size: 1rem;">
                {% for d in available_dates %}
                    <option value="{{ d|date:'Y-m-d' }}" {% if d == date %}selected{% endif %}>{{ d|date:"Yå¹´næœˆjæ—¥" }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    {% if error %}
        <p style="color: red; text-align: center;">{{ error }}</p>
    {% else %}
        <div class="chart-container">
            <canvas id="profitMapChart"></canvas>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // views.pyã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
                const scatterData = {{ scatter_data|default:"[]"|safe }};
                
                if (scatterData.length === 0) {
                    return;
                }

                // è»¸ã®æœ€å¤§å€¤ã‚’èª¿æ•´
                const xValues = scatterData.map(d => d.x);
                const maxX = Math.max(...xValues) * 1.1; 
                
                // â˜…è¿½åŠ : ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‰²æƒ…å ±ã®é…åˆ—ã‚’ä½œæˆ
                // views.py ã§å„ãƒ‡ãƒ¼ã‚¿ã« 'color' ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå«ã¾ã‚Œã¦ã„ã¾ã™
                const pointColors = scatterData.map(d => d.color);

                const ctx = document.getElementById('profitMapChart').getContext('2d');
                new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'éƒ¨é–€ãƒ‡ãƒ¼ã‚¿',
                            data: scatterData,
                            // â˜…å¤‰æ›´: è‰²åˆ†ã‘ã‚’é©ç”¨
                            backgroundColor: pointColors,
                            borderColor: pointColors, // æ ç·šã‚‚åŒã˜è‰²ã«ã™ã‚‹
                            pointRadius: 10,          // å°‘ã—å¤§ããã—ã¦è¦‹ã‚„ã™ã
                            pointHoverRadius: 14
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: { display: true, text: 'å£²ä¸Šè¦æ¨¡ (å³ã»ã©é«˜ã„)', font: {size: 14, weight: 'bold'} },
                                max: maxX,
                                grid: { color: (context) => context.tick.value === 0 ? '#333' : '#ddd' },
                                // å£²ä¸Šé‡‘é¡ï¼ˆæ•°å­—ï¼‰ã¯éš ã™
                                ticks: { display: false }
                            },
                            y: {
                                // æ–‡è¨€å¤‰æ›´: è’åˆ©ç‡ â†’ ç²—åˆ©ç‡
                                title: { display: true, text: 'ç²—åˆ©ç‡ (%)', font: {size: 14, weight: 'bold'} },
                                min: 0,
                                grid: { color: (context) => context.tick.value === 0 ? '#333' : '#ddd' }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const d = context.raw;
                                        // æ–‡è¨€å¤‰æ›´: è’åˆ©ç‡ â†’ ç²—åˆ©ç‡
                                        return `${d.label}: ç²—åˆ©ç‡${d.y}%`;
                                    }
                                }
                            },
                            legend: {
                                display: false // éƒ¨é–€ã”ã¨ã«è‰²ãŒé•ã†ãŸã‚ã€å˜ä¸€ã®å‡¡ä¾‹ã¯éè¡¨ç¤ºã«ã™ã‚‹
                            }
                        }
                    }
                });
            });
        </script>
    {% endif %}
</div>
</body>
</html>