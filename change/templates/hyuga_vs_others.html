<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨é–€åˆ¥æ¨ç§»æ¯”è¼ƒ (æ—¥å‘ vs ä»–åº—)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #6610f2; margin-bottom: 20px; font-size: 1.8rem; }
        .nav-links { margin-bottom: 20px; }
        .nav-links a { text-decoration: none; color: #6c757d; font-weight: bold; padding: 5px 10px; background: #eee; border-radius: 5px; }

        .control-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #ddd; }
        .form-group { margin-bottom: 15px; }
        .form-label { font-weight: bold; display: block; margin-bottom: 5px; }

        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; border-radius: 4px; }
        .checkbox-item label { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; }
        .checkbox-item input { margin-right: 5px; }

        .btn-submit { background: #6610f2; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1rem; width: 100%; transition: background 0.3s; }
        .btn-submit:hover { background: #5a00d3; }

        /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
        .chart-box { padding: 15px; border-radius: 8px; }
        .chart-container { position: relative; height: 50vh; width: 100%; }

        .fixed-shop { padding: 8px 12px; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; color: #495057; font-weight: bold; }

        /* â˜…ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›å‘ã‘ã®èª¿æ•´ (iPad / iPad mini) â˜… */
        @media screen and (max-width: 1024px) {
            body { padding: 10px; }
            .container { padding: 15px; width: 98%; }
            h1 { font-size: 1.5rem; }

            /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®å¯„ã›ã«ã—ã¦æŠ¼ã—ã‚„ã™ã */
            .action-buttons {
                justify-content: center;
            }
            .btn {
                font-size: 0.85rem;
                padding: 8px 12px;
                flex: 1 1 auto; /* å¹…ã‚’è‡ªå‹•èª¿æ•´ */
                text-align: center;
            }
            .separator { display: none; } /* ç‹­ã„ã¨ãã¯åŒºåˆ‡ã‚Šç·šã‚’æ¶ˆã™ */

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåˆ—ã‚’å°‘ã—ç‹­ãã—ã¦è¡¨ç¤ºé ˜åŸŸã‚’ç¢ºä¿ */
            .history-table th.dept-col { width: 140px; }
            .history-table th, .history-table td { font-size: 0.85rem; padding: 8px 4px; }

            /* ãƒãƒƒã‚¸ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
            .rank-num { font-size: 1rem; }
            .share-badge { font-size: 0.7rem; padding: 1px 4px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="nav-links"><a href="{% url 'dashboard' %}">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>
    <h1>ğŸ†š {{ selected_dept_name }} éƒ¨é–€ã®æ¨ç§»æ¯”è¼ƒ</h1>

    {% if error %}
        <p style="color: red; text-align: center;">{{ error }}</p>
    {% else %}
        <form method="get" class="control-panel">
            <div class="form-group">
                <label class="form-label">ğŸ“‚ éƒ¨é–€é¸æŠ:</label>
                <!-- ã“ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å€¤ãŒé€ä¿¡ã•ã‚Œã¾ã™ -->
                <select name="dept_code" onchange="this.form.submit()">
                    {% for dept in all_10_depts %}
                        <option value="{{ dept.code }}" {% if dept.code|stringformat:"s" == selected_dept_code %}selected{% endif %}>
                            {{ dept.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ“… é›†è¨ˆãƒ¢ãƒ¼ãƒ‰:</label>
                <select name="month" onchange="this.form.submit()">
                    <option value="total" {% if selected_month == 'total' %}selected{% endif %}>ãƒˆãƒ¼ã‚¿ãƒ«ï¼ˆå¹´åˆè¨ˆï¼‰</option>
                    {% for m in months %}
                        <option value="{{ m }}" {% if selected_month|default:'total' == m %}selected{% endif %}>{{ m }}æœˆ</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ  è‡ªåº— (åŸºæº–):</label>
                <div class="fixed-shop">{{ target_shop_name }}</div>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ¢ æ¯”è¼ƒã™ã‚‹åº—èˆ— (è¤‡æ•°é¸æŠå¯):</label>

                <!-- â˜…ä¿®æ­£: ã“ã“ã«ã‚ã£ãŸ input type="hidden" name="dept_code" ã‚’å‰Šé™¤ã—ã¾ã—ãŸ -->
                <!-- ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã¨åå‰ãŒé‡è¤‡ã—ã¦ã—ã¾ã„ã€å¤ã„å€¤ãŒé€ä¿¡ã•ã‚Œã‚‹åŸå› ã«ãªã£ã¦ã„ã¾ã—ãŸ -->

                <div class="checkbox-grid">
                    {% for shop in all_shops %}
                        <div class="checkbox-item">
                            <label>
                                <input type="checkbox" name="comparison_shops" value="{{ shop.value }}"
                                    {% if shop.value in selected_display_values %}checked{% endif %}>
                                {{ shop.display }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <button type="submit" class="btn-submit">ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°</button>
        </form>

        <div class="chart-box">
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
            <p style="text-align: center; color: #777; margin-top: 10px;">
                â€» ç¸¦è»¸ã®æ•°å€¤ã¯ä¼ã›ã¦ãŠã‚Šã€ã‚°ãƒ©ãƒ•ã®ã€Œå½¢ã€ãŒå£²ä¸Šæ¨ç§»ã®è¦æ¨¡ã‚’è¡¨ã—ã¾ã™ã€‚
            </p>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const chartData = {{ chart_data|default:"{}"|safe }};

                if (!chartData.datasets || chartData.datasets.length === 0) {
                    return;
                }

                const ctx = document.getElementById('comparisonChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: { display: true, text: 'å¹´æ¬¡' }
                            },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'å£²ä¸Šæ¨ç§» (è¦æ¨¡)' },
                                ticks: {
                                    // é‡‘é¡ã‚’è¡¨ç¤ºï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
                                    display: true,
                                    callback: function(value, index, values) {
                                        try { return Number(value).toLocaleString(); } catch(e) { return value; }
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        var label = context.dataset.label || '';
                                        var v = context.parsed && (context.parsed.y !== undefined ? context.parsed.y : context.parsed);
                                        var num = v ? Number(v).toLocaleString() : '0';
                                        if (label) label += ': ';
                                        return label + num;
                                    }
                                }
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            });
        </script>
    {% endif %}

        <!-- å£²ä¸Šãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¹´ã‚’åˆ—ã€åº—èˆ—ã‚’åˆ—ãƒ˜ãƒƒãƒ€ã€è¡Œã¯å¹´ï¼‰ -->
        {% if table_shops and table_rows %}
        <div style="margin-top:24px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; min-width:700px;">
                <thead>
                    <tr>
                        <th style="text-align:left; padding:8px 12px; background:#f8f9fa;">å¹´</th>
                        {% for s in table_shops %}
                        <th style="text-align:right; padding:8px 12px; background:#f8f9fa;">{{ s.name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_rows %}
                    <tr>
                        <td style="padding:8px 12px; border-top:1px solid #f1f3f5;">{{ row.year }}</td>
                        {% for v in row.values %}
                        <td style="padding:8px 12px; border-top:1px solid #f1f3f5; text-align:right;">{{ v }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th style="text-align:left; padding:8px 12px; background:#fafafa;">åˆè¨ˆ</th>
                        {% for s in table_shops %}
                        <th style="text-align:right; padding:8px 12px; background:#fafafa;">{{ s.total }}</th>
                        {% endfor %}
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}
</div>
</body>
</html>