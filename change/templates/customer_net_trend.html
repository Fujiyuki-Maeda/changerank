<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æ•°ãƒ»ãƒãƒƒãƒˆå£²ä¸Šæ¨ç§»</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; font-size: 1.8rem; }

        .nav-links { margin-bottom: 20px; }
        .nav-links a { text-decoration: none; color: #6c757d; font-weight: bold; padding: 5px 10px; background: #eee; border-radius: 5px; transition: background 0.3s; }
        .nav-links a:hover { background: #ddd; }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .control-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #ddd; }
        .form-group { margin-bottom: 15px; }
        .form-label { font-weight: bold; display: block; margin-bottom: 5px; }

        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; border-radius: 4px; }
        .checkbox-item label { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; }
        .checkbox-item input { margin-right: 5px; }

        .btn-submit { background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1rem; width: 100%; transition: background 0.3s; }
        .btn-submit:hover { background: #138496; }

        /* ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ */
        .charts-wrapper { display: flex; flex-direction: column; gap: 50px; }
        .chart-box { border: 1px solid #eee; padding: 20px; border-radius: 8px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chart-title { text-align: center; font-size: 1.4rem; font-weight: bold; margin-bottom: 15px; color: #555; border-bottom: 2px solid #17a2b8; display: inline-block; padding-bottom: 5px; }
        .chart-title-wrapper { text-align: center; margin-bottom: 10px; }
        .chart-container { position: relative; height: 40vh; width: 100%; }

        /* â˜…ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›å‘ã‘ã®èª¿æ•´ (iPad / iPad mini) â˜… */
        @media screen and (max-width: 1024px) {
            body { padding: 10px; }
            .container { padding: 15px; width: 98%; }
            h1 { font-size: 1.5rem; }

            /* ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®å¯„ã›ã«ã—ã¦æŠ¼ã—ã‚„ã™ã */
            .action-buttons {
                justify-content: center;
            }
            .btn {
                font-size: 0.85rem;
                padding: 8px 12px;
                flex: 1 1 auto; /* å¹…ã‚’è‡ªå‹•èª¿æ•´ */
                text-align: center;
            }
            .separator { display: none; } /* ç‹­ã„ã¨ãã¯åŒºåˆ‡ã‚Šç·šã‚’æ¶ˆã™ */

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåˆ—ã‚’å°‘ã—ç‹­ãã—ã¦è¡¨ç¤ºé ˜åŸŸã‚’ç¢ºä¿ */
            .history-table th.dept-col { width: 140px; }
            .history-table th, .history-table td { font-size: 0.85rem; padding: 8px 4px; }

            /* ãƒãƒƒã‚¸ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
            .rank-num { font-size: 1rem; }
            .share-badge { font-size: 0.7rem; padding: 1px 4px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="nav-links"><a href="{% url 'dashboard' %}">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a></div>

    <h1>ğŸ“ˆ å®¢æ•°ãƒ»ãƒãƒƒãƒˆå£²ä¸Šæ¨ç§»æ¯”è¼ƒ</h1>

    {% if error %}
        <p style="color: red; text-align: center;">{{ error }}</p>
    {% else %}
        <form method="get" class="control-panel">
            <div class="form-group">
                <label class="form-label">ğŸ  è‡ªåº— (åŸºæº–):</label>
                <div style="padding: 8px 12px; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; color: #495057; font-weight: bold; width: 100%; max-width: 300px;">
                    {{ target_shop_name }}
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ¢ æ¯”è¼ƒã™ã‚‹åº—èˆ— (è¤‡æ•°é¸æŠå¯):</label>
                
                <div class="checkbox-grid">
                    {% for shop in all_shops %}
                        <div class="checkbox-item">
                            <label>
                                <input type="checkbox" name="comparison_shops" value="{{ shop.value }}"
                                    {% if shop.value in selected_display_values %}checked{% endif %}>
                                {{ shop.display }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ğŸ“… è¡¨ç¤º: </label>
                <select name="month" style="padding:8px;border-radius:4px;border:1px solid #ccc;max-width:160px;">
                    {% for val,label in month_choices %}
                        <option value="{{ val }}" {% if val == target_month %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="btn-submit">ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º</button>
        </form>

        <div class="charts-wrapper">
            <!-- å®¢æ•°ã‚°ãƒ©ãƒ• -->
            <div class="chart-box">
                <div class="chart-title-wrapper">
                    <div class="chart-title">ğŸ‘¥ å®¢æ•°ã®æ¨ç§»</div>
                </div>
                <div class="chart-container">
                    <canvas id="customerChart"></canvas>
                </div>
                <!-- å®¢æ•°ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div style="margin-top:14px; overflow:auto;">
                    <table class="history-table" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f1f7fa;">
                                <th style="padding:8px;border:1px solid #e6e6e6;">åº—èˆ—</th>
                                {% for y in years %}<th style="padding:8px;border:1px solid #e6e6e6;text-align:right;">{{ y }}</th>{% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in customer_table %}
                                <tr>
                                    <td style="padding:8px;border:1px solid #eee;">{{ row.name }}</td>
                                    {% for a in row.amounts %}
                                        <td style="padding:8px;border:1px solid #eee;text-align:right;">{{ a }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ãƒãƒƒãƒˆå£²ä¸Šã‚°ãƒ©ãƒ• -->
            <div class="chart-box">
                <div class="chart-title-wrapper">
                    <div class="chart-title">ğŸŒ ãƒãƒƒãƒˆå£²ä¸Šã®æ¨ç§»</div>
                </div>
                <div class="chart-container">
                    <canvas id="netChart"></canvas>
                </div>
                <!-- ãƒãƒƒãƒˆå£²ä¸Šãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div style="margin-top:14px; overflow:auto;">
                    <table class="history-table" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#fff6f1;">
                                <th style="padding:8px;border:1px solid #e6e6e6;">åº—èˆ—</th>
                                {% for y in years %}<th style="padding:8px;border:1px solid #e6e6e6;text-align:right;">{{ y }}</th>{% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in net_table %}
                                <tr>
                                    <td style="padding:8px;border:1px solid #eee;">{{ row.name }}</td>
                                    {% for a in row.amounts %}
                                        <td style="padding:8px;border:1px solid #eee;text-align:right;">{{ a }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // views.pyã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
                const customerData = {{ customer_chart|default:"{}"|safe }};
                const netData = {{ net_chart|default:"{}"|safe }};

                // å…±é€šã‚ªãƒ—ã‚·ãƒ§ãƒ³
                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const v = ctx.parsed.y ?? ctx.parsed;
                                    if (v === null || v === undefined) return ctx.dataset.label + ': -';
                                    return ctx.dataset.label + ': ' + Number(v).toLocaleString();
                                }
                            }
                        }
                    }
                };

                // 1. å®¢æ•°ãƒãƒ£ãƒ¼ãƒˆ
                if (customerData.datasets && customerData.datasets.length > 0) {
                    const ctxCustomer = document.getElementById('customerChart').getContext('2d');
                    new Chart(ctxCustomer, {
                        type: 'line',
                        data: customerData,
                        options: {
                            ...commonOptions,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'å®¢æ•°' },
                                    ticks: {
                                        callback: function(val) { return Number(val).toLocaleString(); },
                                        precision: 0
                                    }
                                }
                            },
                            plugins: commonOptions.plugins,
                            onClick: commonOptions.onClick
                        }
                    });
                }

                // 2. ãƒãƒƒãƒˆå£²ä¸Šãƒãƒ£ãƒ¼ãƒˆ
                if (netData.datasets && netData.datasets.length > 0) {
                    const ctxNet = document.getElementById('netChart').getContext('2d');
                    new Chart(ctxNet, {
                        type: 'line',
                        data: netData,
                        options: {
                            ...commonOptions,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'ãƒãƒƒãƒˆå£²ä¸Šï¼ˆå††ï¼‰' },
                                    ticks: {
                                        callback: function(val) { return Number(val).toLocaleString(); },
                                        precision: 0
                                    }
                                }
                            },
                            plugins: commonOptions.plugins
                        }
                    });
                }
            });
        </script>
    {% endif %}
</div>
</body>
</html>